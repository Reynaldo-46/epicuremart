{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <!-- Enhanced Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-2">
                    <i class="fas fa-shopping-cart text-primary me-2"></i>Shopping Cart
                </h2>
                <p class="text-muted mb-0">Review your items before checkout</p>
            </div>
            <a href="{{ url_for('browse') }}" class="btn btn-outline-primary">
                <i class="fas fa-plus-circle me-2"></i>Add More Items
            </a>
        </div>
    </div>
    
    {% if has_stock_error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Stock Issue!</strong> One or more items exceed available stock. Please adjust your cart before checking out.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if cart_items %}
    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Select All Card -->
            <div class="card mb-3 border-0 shadow-sm bg-light">
                <div class="card-body py-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                        <label class="form-check-label fw-bold" for="selectAllCheckbox">
                            <i class="fas fa-check-double me-2"></i>Select All Items ({{ cart_items|length }})
                        </label>
                    </div>
                </div>
            </div>
            
            {% for item in cart_items %}
            <div class="cart-item-card card mb-3 border-0 shadow-sm {% if item.exceeds_stock %}border-danger{% endif %}" id="cart-item-{{ item.cart_item_id }}">
                <div class="card-body p-3">
                    <div class="row align-items-center g-3">
                        <!-- Checkbox -->
                        <div class="col-auto">
                            <input class="form-check-input cart-item-checkbox" 
                                   type="checkbox" 
                                   value="{{ item.cart_item_id }}"
                                   data-price="{{ item.subtotal }}"
                                   data-exceeds-stock="{{ 'true' if item.exceeds_stock else 'false' }}"
                                   id="checkbox-{{ item.cart_item_id }}"
                                   style="width: 1.25rem; height: 1.25rem;">
                        </div>
                        
                        <!-- Product Image -->
                        <div class="col-auto">
                            <div class="cart-item-image">
                                {% if item.product.image %}
                                <img src="{{ url_for('static', filename='uploads/' + item.product.image) }}" 
                                     class="img-fluid rounded" alt="{{ item.product.name }}">
                                {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                     style="width: 100px; height: 100px;">
                                    <i class="fas fa-image fa-2x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Product Info -->
                        <div class="col">
                            <h5 class="mb-1 fw-bold">{{ item.product.name }}</h5>
                            <p class="text-muted mb-1 small">
                                <i class="fas fa-store me-1"></i>{{ item.product.shop.name }}
                            </p>
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-box me-1"></i>Stock: {{ item.product.stock }}
                                </span>
                                {% if item.exceeds_stock %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-circle me-1"></i>Exceeds Stock!
                                </span>
                                {% endif %}
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>Added {{ item.created_at.strftime('%b %d, %Y') }}
                                </small>
                            </div>
                        </div>
                        
                        <!-- Price -->
                        <div class="col-lg-auto text-center">
                            <div class="text-muted small mb-1">Unit Price</div>
                            <h6 class="mb-0 fw-bold text-primary">
                                ₱<span class="item-price" data-price="{{ item.product.price }}">{{ "%.2f"|format(item.product.price) }}</span>
                            </h6>
                        </div>
                        
                        <!-- Quantity Controls -->
                        <div class="col-lg-auto">
                            <div class="text-muted small mb-2 text-center">Quantity</div>
                            <form method="POST" action="{{ url_for('update_cart_quantity', cart_item_id=item.cart_item_id) }}" class="quantity-control">
                                <div class="input-group input-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" onclick="decrementCartQty(this)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" 
                                           name="quantity" 
                                           value="{{ item.quantity }}" 
                                           min="1" 
                                           max="{{ item.product.stock }}" 
                                           class="form-control text-center quantity-input {% if item.exceeds_stock %}is-invalid{% endif %}"
                                           data-cart-item-id="{{ item.cart_item_id }}"
                                           style="width: 60px;"
                                           readonly
                                           {% if item.exceeds_stock %}title="Exceeds available stock"{% endif %}>
                                    <button type="button" class="btn btn-outline-secondary" onclick="incrementCartQty(this, {{ item.product.stock }})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button type="submit" class="btn btn-primary" title="Update quantity">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Subtotal -->
                        <div class="col-lg-auto text-center">
                            <div class="text-muted small mb-1">Subtotal</div>
                            <h5 class="mb-0 fw-bold">₱<span class="item-subtotal">{{ "%.2f"|format(item.subtotal) }}</span></h5>
                        </div>
                        
                        <!-- Remove Button -->
                        <div class="col-auto">
                            <a href="{{ url_for('remove_from_cart', cart_item_id=item.cart_item_id) }}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Remove this item from cart?')"
                               title="Remove item">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                <div class="card-header bg-white border-0 py-3">
                    <h4 class="mb-0 fw-bold">
                        <i class="fas fa-receipt text-primary me-2"></i>Order Summary
                    </h4>
                </div>
                <div class="card-body">
                    <div class="summary-item">
                        <span class="text-muted">Total Items:</span>
                        <span class="badge bg-secondary">{{ cart_items|length }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="text-muted">Selected Items:</span>
                        <span class="badge bg-primary" id="selected-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="text-muted">Selected Subtotal:</span>
                        <span class="fw-semibold">₱<span id="selected-total">0.00</span></span>
                    </div>
                    <hr class="my-3">
                    <div class="summary-item mb-3">
                        <span class="fw-bold h5 mb-0">Total:</span>
                        <span class="fw-bold h4 text-primary mb-0">₱<span id="cart-total-display">0.00</span></span>
                    </div>
                    
                    <div id="stock-error-alert" class="alert alert-danger d-none mb-3 py-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <small>Selected items contain stock issues</small>
                    </div>
                    
                    <form id="checkout-form" method="POST" action="{{ url_for('checkout') }}">
                        <input type="hidden" name="selected_items" id="selected-items-input" value="">
                        <button type="submit" id="checkout-btn" class="btn btn-primary btn-lg w-100 mb-2" disabled>
                            <i class="fas fa-credit-card me-2"></i>Proceed to Checkout
                            <br>
                            <small class="d-block mt-1" style="font-size: 0.75rem;">
                                (<span id="checkout-count">0</span> items selected)
                            </small>
                        </button>
                    </form>
                    
                    <a href="{{ url_for('browse') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                    </a>
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="d-flex align-items-start gap-2">
                            <i class="fas fa-shield-alt text-success mt-1"></i>
                            <small class="text-muted">
                                Your cart is secure. All transactions are encrypted and protected.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm text-center p-5">
                <div class="mb-4">
                    <i class="fas fa-shopping-cart fa-5x text-muted opacity-50"></i>
                </div>
                <h3 class="fw-bold mb-3">Your cart is empty</h3>
                <p class="text-muted mb-4">Looks like you haven't added anything to your cart yet. Start shopping to fill it up!</p>
                <a href="{{ url_for('browse') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-shopping-bag me-2"></i>Start Shopping
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* Cart Item Card */
    .cart-item-card {
        transition: all 0.3s ease;
    }
    
    .cart-item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }
    
    .cart-item-image img {
        width: 100px;
        height: 100px;
        object-fit: cover;
    }
    
    /* Quantity Control */
    .quantity-control {
        max-width: 180px;
    }
    
    .quantity-input {
        pointer-events: none;
        background-color: white !important;
    }
    
    /* Summary Items */
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 991px) {
        .cart-item-card .row > div {
            margin-bottom: 0.5rem;
        }
        
        .cart-item-image img {
            width: 80px;
            height: 80px;
        }
    }
    
    @media (max-width: 576px) {
        .cart-item-image img {
            width: 60px;
            height: 60px;
        }
        
        .quantity-control {
            max-width: 100%;
        }
    }
</style>

<script>
    // Cart quantity controls
    function incrementCartQty(btn, max) {
        const input = btn.closest('.quantity-control').querySelector('.quantity-input');
        const currentVal = parseInt(input.value) || 1;
        if (currentVal < max) {
            input.value = currentVal + 1;
        }
    }
    
    function decrementCartQty(btn) {
        const input = btn.closest('.quantity-control').querySelector('.quantity-input');
        const currentVal = parseInt(input.value) || 1;
        if (currentVal > 1) {
            input.value = currentVal - 1;
        }
    }
// Real-time price calculation when quantity changes
document.addEventListener('DOMContentLoaded', function() {
    const quantityInputs = document.querySelectorAll('.quantity-input');
    
    quantityInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateItemSubtotal(this);
            updateCartTotal();
        });
    });
});

function updateItemSubtotal(input) {
    const cartItemId = input.dataset.cartItemId;
    const cartItem = document.getElementById('cart-item-' + cartItemId);
    const priceElement = cartItem.querySelector('.item-price');
    const subtotalElement = cartItem.querySelector('.item-subtotal');
    
    const price = parseFloat(priceElement.dataset.price);
    const quantity = parseInt(input.value) || 0;
    const subtotal = price * quantity;
    
    subtotalElement.textContent = subtotal.toFixed(2);
}

function updateCartTotal() {
    let total = 0;
    document.querySelectorAll('.item-subtotal').forEach(subtotalElement => {
        total += parseFloat(subtotalElement.textContent) || 0;
    });
    
    document.getElementById('cart-total').textContent = total.toFixed(2);
    document.getElementById('cart-total-display').textContent = total.toFixed(2);
}

// Selective Checkout Functionality
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.cart-item-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkoutBtn = document.getElementById('checkout-btn');
    const selectedItemsInput = document.getElementById('selected-items-input');
    const stockErrorAlert = document.getElementById('stock-error-alert');
    
    // Update selection summary
    function updateSelectionSummary() {
        const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
        const selectedCount = checkedBoxes.length;
        let selectedTotal = 0;
        let hasStockError = false;
        
        checkedBoxes.forEach(checkbox => {
            selectedTotal += parseFloat(checkbox.dataset.price) || 0;
            if (checkbox.dataset.exceedsStock === 'true') {
                hasStockError = true;
            }
        });
        
        // Update UI
        document.getElementById('selected-count').textContent = selectedCount;
        document.getElementById('selected-total').textContent = selectedTotal.toFixed(2);
        document.getElementById('cart-total-display').textContent = selectedTotal.toFixed(2);
        document.getElementById('checkout-count').textContent = selectedCount;
        
        // Enable/disable checkout button
        if (selectedCount === 0) {
            checkoutBtn.disabled = true;
            stockErrorAlert.classList.add('d-none');
        } else if (hasStockError) {
            checkoutBtn.disabled = true;
            stockErrorAlert.classList.remove('d-none');
        } else {
            checkoutBtn.disabled = false;
            stockErrorAlert.classList.add('d-none');
        }
        
        // Update hidden input with selected cart item IDs
        const selectedIds = checkedBoxes.map(cb => cb.value).join(',');
        selectedItemsInput.value = selectedIds;
    }
    
    // Handle individual checkbox change
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectionSummary();
            // Update select all checkbox state
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        });
    });
    
    // Handle select all checkbox
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectionSummary();
        });
    }
    
    // Initialize
    updateSelectionSummary();
});
</script>

<style>
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.quantity-input {
    -moz-appearance: textfield;
}
</style>
{% endblock %}