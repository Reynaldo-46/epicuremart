{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Shopping Cart</h2>
    
    {% if has_stock_error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> One or more items exceed available stock. Please adjust your cart before checking out.
    </div>
    {% endif %}
    
    {% if cart_items %}
    <div class="row">
        <div class="col-lg-8">
            <!-- Select All Checkbox -->
            <div class="card mb-3 bg-light">
                <div class="card-body py-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                        <label class="form-check-label fw-bold" for="selectAllCheckbox">
                            Select All Items
                        </label>
                    </div>
                </div>
            </div>
            
            {% for item in cart_items %}
            <div class="card mb-3 {% if item.exceeds_stock %}border-danger{% endif %}" id="cart-item-{{ item.cart_item_id }}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <input class="form-check-input cart-item-checkbox" 
                                   type="checkbox" 
                                   value="{{ item.cart_item_id }}"
                                   data-price="{{ item.subtotal }}"
                                   data-exceeds-stock="{{ 'true' if item.exceeds_stock else 'false' }}"
                                   id="checkbox-{{ item.cart_item_id }}">
                        </div>
                        <div class="col-md-2">
                            {% if item.product.image %}
                            <img src="{{ url_for('static', filename='uploads/' + item.product.image) }}" class="img-fluid rounded" alt="{{ item.product.name }}">
                            {% else %}
                            <div class="bg-secondary rounded p-3 text-center">
                                <i class="fas fa-image fa-2x text-white"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <h5>{{ item.product.name }}</h5>
                            <p class="text-muted mb-0">{{ item.product.shop.name }}</p>
                            <small class="text-muted">Stock: {{ item.product.stock }}</small>
                            {% if item.exceeds_stock %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> Exceeds available stock!
                            </div>
                            {% endif %}
                            <small class="text-muted d-block">Added: {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <div class="col-md-2">
                            <p class="mb-0">₱<span class="item-price" data-price="{{ item.product.price }}">{{ "%.2f"|format(item.product.price) }}</span></p>
                        </div>
                        <div class="col-md-2">
                            <form method="POST" action="{{ url_for('update_cart_quantity', cart_item_id=item.cart_item_id) }}" class="d-flex align-items-center gap-2">
                                <input type="number" 
                                       name="quantity" 
                                       value="{{ item.quantity }}" 
                                       min="1" 
                                       max="{{ item.product.stock }}" 
                                       class="form-control form-control-sm quantity-input {% if item.exceeds_stock %}is-invalid{% endif %}"
                                       data-cart-item-id="{{ item.cart_item_id }}"
                                       style="width: 70px;"
                                       {% if item.exceeds_stock %}title="Exceeds available stock"{% endif %}>
                                <button type="submit" class="btn btn-sm btn-outline-primary" title="Update quantity">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </form>
                        </div>
                        <div class="col-md-2 text-end">
                            <p class="fw-bold mb-2">₱<span class="item-subtotal">{{ "%.2f"|format(item.subtotal) }}</span></p>
                            <a href="{{ url_for('remove_from_cart', cart_item_id=item.cart_item_id) }}" 
                               class="btn btn-sm btn-danger"
                               onclick="return confirm('Remove this item from cart?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h4>Order Summary</h4>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Items:</span>
                        <span class="badge bg-secondary">{{ cart_items|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Selected Items:</span>
                        <span class="badge bg-primary" id="selected-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Selected Subtotal:</span>
                        <span>₱<span id="selected-total">0.00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total:</span>
                        <span class="fw-bold h4">₱<span id="cart-total-display">0.00</span></span>
                    </div>
                    
                    <div id="stock-error-alert" class="alert alert-danger d-none mb-3">
                        <i class="fas fa-exclamation-triangle"></i> Selected items contain stock issues
                    </div>
                    
                    <form id="checkout-form" method="POST" action="{{ url_for('checkout') }}">
                        <input type="hidden" name="selected_items" id="selected-items-input" value="">
                        <button type="submit" id="checkout-btn" class="btn btn-primary w-100" disabled>
                            <i class="fas fa-credit-card"></i> Proceed to Checkout (<span id="checkout-count">0</span> items)
                        </button>
                    </form>
                    
                    <a href="{{ url_for('browse') }}" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="fas fa-arrow-left"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        Your cart is empty. <a href="{{ url_for('browse') }}">Start shopping!</a>
    </div>
    {% endif %}
</div>

<script>
// Real-time price calculation when quantity changes
document.addEventListener('DOMContentLoaded', function() {
    const quantityInputs = document.querySelectorAll('.quantity-input');
    
    quantityInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateItemSubtotal(this);
            updateCartTotal();
        });
    });
});

function updateItemSubtotal(input) {
    const cartItemId = input.dataset.cartItemId;
    const cartItem = document.getElementById('cart-item-' + cartItemId);
    const priceElement = cartItem.querySelector('.item-price');
    const subtotalElement = cartItem.querySelector('.item-subtotal');
    
    const price = parseFloat(priceElement.dataset.price);
    const quantity = parseInt(input.value) || 0;
    const subtotal = price * quantity;
    
    subtotalElement.textContent = subtotal.toFixed(2);
}

function updateCartTotal() {
    let total = 0;
    document.querySelectorAll('.item-subtotal').forEach(subtotalElement => {
        total += parseFloat(subtotalElement.textContent) || 0;
    });
    
    document.getElementById('cart-total').textContent = total.toFixed(2);
    document.getElementById('cart-total-display').textContent = total.toFixed(2);
}

// Selective Checkout Functionality
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.cart-item-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkoutBtn = document.getElementById('checkout-btn');
    const selectedItemsInput = document.getElementById('selected-items-input');
    const stockErrorAlert = document.getElementById('stock-error-alert');
    
    // Update selection summary
    function updateSelectionSummary() {
        const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
        const selectedCount = checkedBoxes.length;
        let selectedTotal = 0;
        let hasStockError = false;
        
        checkedBoxes.forEach(checkbox => {
            selectedTotal += parseFloat(checkbox.dataset.price) || 0;
            if (checkbox.dataset.exceedsStock === 'true') {
                hasStockError = true;
            }
        });
        
        // Update UI
        document.getElementById('selected-count').textContent = selectedCount;
        document.getElementById('selected-total').textContent = selectedTotal.toFixed(2);
        document.getElementById('cart-total-display').textContent = selectedTotal.toFixed(2);
        document.getElementById('checkout-count').textContent = selectedCount;
        
        // Enable/disable checkout button
        if (selectedCount === 0) {
            checkoutBtn.disabled = true;
            stockErrorAlert.classList.add('d-none');
        } else if (hasStockError) {
            checkoutBtn.disabled = true;
            stockErrorAlert.classList.remove('d-none');
        } else {
            checkoutBtn.disabled = false;
            stockErrorAlert.classList.add('d-none');
        }
        
        // Update hidden input with selected cart item IDs
        const selectedIds = checkedBoxes.map(cb => cb.value).join(',');
        selectedItemsInput.value = selectedIds;
    }
    
    // Handle individual checkbox change
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectionSummary();
            // Update select all checkbox state
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        });
    });
    
    // Handle select all checkbox
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectionSummary();
        });
    }
    
    // Initialize
    updateSelectionSummary();
});
</script>

<style>
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.quantity-input {
    -moz-appearance: textfield;
}
</style>
{% endblock %}