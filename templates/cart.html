{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Shopping Cart</h2>
    
    {% if has_stock_error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> One or more items exceed available stock. Please adjust your cart before checking out.
    </div>
    {% endif %}
    
    {% if cart_items %}
    <div class="row">
        <div class="col-lg-8">
            {% for item in cart_items %}
            <div class="card mb-3 {% if item.exceeds_stock %}border-danger{% endif %}" id="cart-item-{{ item.cart_item_id }}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            {% if item.product.image %}
                            <img src="{{ url_for('static', filename='uploads/' + item.product.image) }}" class="img-fluid rounded" alt="{{ item.product.name }}">
                            {% else %}
                            <div class="bg-secondary rounded p-3 text-center">
                                <i class="fas fa-image fa-2x text-white"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h5>{{ item.product.name }}</h5>
                            <p class="text-muted mb-0">{{ item.product.shop.name }}</p>
                            <small class="text-muted">Stock: {{ item.product.stock }}</small>
                            {% if item.exceeds_stock %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> Exceeds available stock!
                            </div>
                            {% endif %}
                            <small class="text-muted d-block">Added: {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <div class="col-md-2">
                            <p class="mb-0">₱<span class="item-price" data-price="{{ item.product.price }}">{{ "%.2f"|format(item.product.price) }}</span></p>
                        </div>
                        <div class="col-md-2">
                            <form method="POST" action="{{ url_for('update_cart_quantity', cart_item_id=item.cart_item_id) }}" class="d-flex align-items-center gap-2">
                                <input type="number" 
                                       name="quantity" 
                                       value="{{ item.quantity }}" 
                                       min="1" 
                                       max="{{ item.product.stock }}" 
                                       class="form-control form-control-sm quantity-input {% if item.exceeds_stock %}is-invalid{% endif %}"
                                       data-cart-item-id="{{ item.cart_item_id }}"
                                       style="width: 70px;"
                                       {% if item.exceeds_stock %}title="Exceeds available stock"{% endif %}>
                                <button type="submit" class="btn btn-sm btn-outline-primary" title="Update quantity">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </form>
                        </div>
                        <div class="col-md-2 text-end">
                            <p class="fw-bold mb-2">₱<span class="item-subtotal">{{ "%.2f"|format(item.subtotal) }}</span></p>
                            <a href="{{ url_for('remove_from_cart', cart_item_id=item.cart_item_id) }}" 
                               class="btn btn-sm btn-danger"
                               onclick="return confirm('Remove this item from cart?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h4>Order Summary</h4>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Cart Items (transactions):</span>
                        <span class="badge bg-primary">{{ cart_items|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>₱<span id="cart-total">{{ "%.2f"|format(total) }}</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="fw-bold">Total:</span>
                        <span class="fw-bold h4">₱<span id="cart-total-display">{{ "%.2f"|format(total) }}</span></span>
                    </div>
                    {% if has_stock_error %}
                    <button class="btn btn-secondary w-100" disabled title="Fix stock issues first">
                        <i class="fas fa-exclamation-triangle"></i> Cannot Checkout - Stock Issues
                    </button>
                    {% else %}
                    <a href="{{ url_for('checkout') }}" class="btn btn-primary w-100">
                        <i class="fas fa-credit-card"></i> Proceed to Checkout
                    </a>
                    {% endif %}
                    <a href="{{ url_for('browse') }}" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="fas fa-arrow-left"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        Your cart is empty. <a href="{{ url_for('browse') }}">Start shopping!</a>
    </div>
    {% endif %}
</div>

<script>
// Real-time price calculation when quantity changes
document.addEventListener('DOMContentLoaded', function() {
    const quantityInputs = document.querySelectorAll('.quantity-input');
    
    quantityInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateItemSubtotal(this);
            updateCartTotal();
        });
    });
});

function updateItemSubtotal(input) {
    const cartItemId = input.dataset.cartItemId;
    const cartItem = document.getElementById('cart-item-' + cartItemId);
    const priceElement = cartItem.querySelector('.item-price');
    const subtotalElement = cartItem.querySelector('.item-subtotal');
    
    const price = parseFloat(priceElement.dataset.price);
    const quantity = parseInt(input.value) || 0;
    const subtotal = price * quantity;
    
    subtotalElement.textContent = subtotal.toFixed(2);
}

function updateCartTotal() {
    let total = 0;
    document.querySelectorAll('.item-subtotal').forEach(subtotalElement => {
        total += parseFloat(subtotalElement.textContent) || 0;
    });
    
    document.getElementById('cart-total').textContent = total.toFixed(2);
    document.getElementById('cart-total-display').textContent = total.toFixed(2);
}
</script>

<style>
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.quantity-input {
    -moz-appearance: textfield;
}
</style>
{% endblock %}