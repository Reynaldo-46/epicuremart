{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Seller Dashboard - {{ shop.name }}</h2>
        
        <!-- Time Filter Dropdown and Custom Date Range -->
        <div class="d-flex gap-2">
            <!-- Custom Date Range Form -->
            <form method="GET" class="d-flex gap-2 align-items-center">
                <input type="date" name="start_date" class="form-control form-control-sm" 
                       value="{{ start_date if start_date else '' }}" 
                       placeholder="Start Date">
                <input type="date" name="end_date" class="form-control form-control-sm" 
                       value="{{ end_date if end_date else '' }}" 
                       placeholder="End Date">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-search"></i> Filter
                </button>
            </form>
            
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-filter"></i> 
                    {% if time_filter == 'day' %}Today
                    {% elif time_filter == 'week' %}This Week
                    {% elif time_filter == 'month' %}This Month
                    {% elif time_filter == 'year' %}This Year
                    {% elif time_filter == 'custom' %}Custom Range
                    {% else %}All Time{% endif %}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="?filter=day">Today</a></li>
                    <li><a class="dropdown-item" href="?filter=week">This Week</a></li>
                    <li><a class="dropdown-item" href="?filter=month">This Month</a></li>
                    <li><a class="dropdown-item" href="?filter=year">This Year</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="?filter=all">All Time</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <h3>{{ total_products }}</h3>
                <p class="mb-0"><i class="fas fa-box"></i> Total Products</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h3>{{ total_orders }}</h3>
                <p class="mb-0"><i class="fas fa-shopping-bag"></i> Total Orders</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <h3>{{ pending_orders }}</h3>
                <p class="mb-0"><i class="fas fa-clock"></i> Pending</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                <h3>{{ ready_orders }}</h3>
                <p class="mb-0"><i class="fas fa-check"></i> Ready</p>
            </div>
        </div>
    </div>

    <!-- Revenue Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <h3>₱{{ "%.2f"|format(total_revenue) }}</h3>
                <p class="mb-0"><i class="fas fa-coins"></i> Total Revenue</p>
                <small class="text-white-50">After commission</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <h3>₱{{ "%.2f"|format(total_sales) }}</h3>
                <p class="mb-0"><i class="fas fa-chart-line"></i> Total Sales</p>
                <small class="text-white-50">Before commission</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                <h3>₱{{ "%.2f"|format(avg_order_value) }}</h3>
                <p class="mb-0"><i class="fas fa-receipt"></i> Avg Order Value</p>
                <small class="text-white-50">Per delivered order</small>
            </div>
        </div>
    </div>

    <!-- Sales Performance Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-area"></i> Sales Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="salesChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Products & Quick Actions Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-trophy"></i> Top Selling Products</h5>
                </div>
                <div class="card-body">
                    {% if top_products %}
                    <div class="list-group list-group-flush">
                        {% for product in top_products %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ product.name }}</span>
                            <span class="badge bg-primary rounded-pill">{{ product.total_sold }} sold</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No sales data yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-rocket"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('create_product') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Product
                        </a>
                        <a href="{{ url_for('seller_products') }}" class="btn btn-outline-primary">
                            <i class="fas fa-box"></i> Manage Products
                        </a>
                        <a href="{{ url_for('seller_orders') }}" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i> View All Orders
                        </a>
                        <a href="{{ url_for('messages_inbox') }}" class="btn btn-outline-primary">
                            <i class="fas fa-envelope"></i> Messages
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Orders -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-receipt"></i> Recent Orders</h5>
        </div>
        <div class="card-body">
            {% if recent_orders %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in recent_orders %}
                        <tr>
                            <td><strong>{{ order.order_number }}</strong></td>
                            <td>{{ order.customer.full_name }}</td>
                            <td>₱{{ "%.2f"|format(order.total_amount) }}</td>
                            <td>
                                <span class="badge badge-status 
                                    {% if order.status == 'PENDING_PAYMENT' %}bg-warning
                                    {% elif order.status == 'READY_FOR_PICKUP' %}bg-info
                                    {% elif order.status == 'DELIVERED' %}bg-success
                                    {% else %}bg-primary{% endif %}">
                                    {{ order.status.replace('_', ' ') }}
                                </span>
                            </td>
                            <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <a href="{{ url_for('seller_order_detail', order_id=order.id) }}" class="btn btn-sm btn-outline-primary">
                                    View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No orders yet.</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Sales Performance Chart
const salesData = {{ revenue_chart_data | tojson }};
const labels = salesData.map(d => d.label);
const values = salesData.map(d => d.value);

const ctx = document.getElementById('salesChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Revenue (₱)',
            data: values,
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgb(99, 102, 241)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '₱' + context.parsed.y.toFixed(2);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '₱' + value.toFixed(0);
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}